# rdb-aof

持久化机制rdb(redisDataBase)/aof(append only file)

redis是一个内存数据库，数据保存在内存中，但是我们都知道内存的数据变化是很快的，也容易发生丢失。幸好Redis还为我们提供了持久化的机制，分别是RDB(Redis DataBase)和AOF(Append Only File)。

持久化需要的过程：
1. 客户端向服务端发送写操作(数据在客户端的内存中)。
1. 数据库服务端接收到写请求的数据(数据在服务端的内存中)。
1. 服务端调用write这个系统调用，将数据往磁盘上写(数据在系统内存的缓冲区中)。
1. 操作系统将缓冲区中的数据转移到磁盘控制器上(数据在磁盘缓存中)。
1. 磁盘控制器将数据写到磁盘的物理介质中(数据真正落到磁盘上)。

过程中可能出现的故障：
1. Redis数据库发生故障，只要在上面的第三步执行完毕，那么就可以持久化保存，剩下的两步由操作系统替我们完成。
1. 操作系统发生故障，必须上面5步都完成才可以。

## rdb机制

这是redis默认的持久化方式。
对所有数据快照，再把快照写入二进制文件中。默认文件名为dump.rdb
redis.conf文件中设置的rdb/aof的各种配置。
有三种方式可以触发rdb机制。

### save

执行此方式时，redis会阻塞服务。

### bgsave

redis会fork出一个子进程。fork时会阻塞。fork后不阻塞。由子进程负责rdb操作。完成后自动结束子进程。因其阻塞时间短，一般采用此方式。

### 自动化

在redis.conf文件中修改相应设置。
save 在m秒内执行n次修改时，触发bgsave. `save m n` 若不需要自动持久化，则删除所有save.
stop-writes-on-bgsave-error 默认为false 是否在保存数据时出错时，停止接收数据。redis重启后，可开始接收数据。
rdbcompression 默认为yes 是否使用压缩保存。
rdbchecksum 默认为yes 在保存数据前是否（使用crc64算法）执行数据校验。若开此功能会增加约10%的性能消耗。
dbfilename 快照的文件名
dir 快照的文件路径

### rdb的优势、劣势

1. 全量备份。文件紧凑。适用于备份、灾难恢复。
2. 不阻塞io.
3. 恢复大数据集时给aof快。
1. 可能挂失持久化期间的数据变化。

## aof机制

在aof文件中保存修改命令。

### 重写原理
aof文件重写。把内存中的数据写入aof文件。不使用旧aof文件。

客户端发送bgrewriteaof命令。redis fork出一个子进程。子进程把内存中的数据写入aof文件。

### 解发方式：
1. always 每修改同步 数据完整性好，性能差。
1. everysec 每秒同步 会丢失一秒内的数据。
1. no 不同步

### 优势、劣势

1. 最多丢失1s数据。
2. 写入性能高，文件不易破损。
3. aof文件过大时，会曩客户端的读写。
4. aof可读性好。
1. aof文件比快照大
2. aof开启后，支持写的qps比rdb的qps低。
3. aof发生bug时，不能完全恢复数据。

## 比较rdb/aof

||rdb|aof|||
|-|-|-|-|-|
|启动优先级|低|高|||
|体积|小|大|||
|恢复速度|快|慢|||
|数据安全性|丢数据|根据策略决定|||
|轻重|重|轻|||

