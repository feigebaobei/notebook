# 执行机制

js是单线程的。
浏览器是多线程的。
浏览器把代码分同步代码与异步代码。
当运行到同步代码时执行并向下运行。当运行了异步代码时把异步代码放入任务队列。
当把全部同步代码执行完后，再执行任务队列里的异步代码。

任务队列里分为宏任务队列和微任务队列。
宏任务队列可以有多个。
微任务队列只能有一个。

宏任务（task）：就是JS 内部（任务队列里）的任务，严格按照时间顺序压栈和执行。如 setTimeOut、setInverter、setImmediate 、 MessageChannel等
微任务（Microtask ）：通常来说就是需要在当前宏任务执行结束后立即执行的任务，例如需要对一系列的任务做出回应，或者是需要异步的执行任务而又不需要分配一个新的 任务 ，这样便可以减小一点性能的开销。
在挂起任务时，JS引擎会将所有任务按照类别分到这两个队列中，首先在 macrotask 的队列（这个队列也被叫做 task queue）中取出第一个任务，执行完毕后取出 microtask 队列中的所有任务顺序执行；之后再取 macrotask 任务，周而复始，直至两个队列的任务都取完。

宏任务与微任务的属性机制
||browser|node|
|-|-|-|
|setTimeout|v|v|
|setInterval|v|v|
|setImmediate|x|v|
|requestAnimationFrame|v|x|

||browser|node|
|-|-|-|
|process.nextTick|x|v|
|MutationObserver|v|x|
|Promise.then catch finally|v|v|

## 运行机制

1. 在执行栈中执行一个宏任务。
2. 在执行宏任务中遇到微任务时，把微任务放在要微任务队列中。
3. 当宏任务执行完后，把微任务队列执行完。（如：检查渲染，gui线程接管渲染……）
4. 渲染完毕后，js线程接管，开启下一次事件循环，执行下一次宏任务。

```
|---------------------------------------|
|                                       |
|     |------------|    |-----------|   |
|     |            |    |           |   |
|     |   宏任务    |    |    微任务  |   |
|     |            |    |           |   |
|     |------------|    |-----------|   |
|                                       |
|---------------------------------------|
```